x-default: &node
  # Corresponds to the user set in the Dockerfile and the shiny-server
  # user on the server for proper write perms to mounted directories
  user: "${UID:-1003}:0"
  image: ghcr.io/ccao-data/service-spark-iasworld:${ENV:?}
  build:
    context: .
    dockerfile: Dockerfile
  restart: ${SPARK_RESTART_POLICY:?}
  volumes:
    - ./drivers:/jdbc:ro
    - ./src:/tmp/src:ro
    - ./config:/tmp/config:ro
    - ./config/spark-defaults.conf:/opt/bitnami/spark/conf/spark-defaults.conf:ro
    - ./target:/tmp/target:rw
    - ./logs:/tmp/logs:rw
  secrets:
    - AWS_CREDENTIALS
    - GH_PEM
    - IPTS_PRD_PASSWORD
    - IPTS_TST_PASSWORD
    - IPTS_CONNECTION
    - SPARK_ENV
  networks:
    - sparknet

# These environmental variables get merged into the env vars of containers.
# See: https://docs.docker.com/reference/compose-file/extension/#example-4
x-spark-env: &spark-env
  SPARK_MASTER_URL: spark://spark-node-master-${ENV:?}:7077
  SPARK_PUBLIC_DNS: ${SPARK_PUBLIC_IP:?}
  SPARK_LOCAL_STORAGE_ENCRYPTION_ENABLED: no
  SPARK_RPC_AUTHENTICATION_ENABLED: no
  SPARK_RPC_ENCRYPTION_ENABLED: no
  SPARK_SSL_ENABLED: no

  AWS_SHARED_CREDENTIALS_FILE: /run/secrets/AWS_CREDENTIALS
  IPTS_CONNECTION_FILE: /run/secrets/IPTS_CONNECTION
  SPARK_ENV_FILE: /run/secrets/SPARK_ENV

services:
  spark-node-master:
    <<: *node
    container_name: spark-node-master-${ENV:?}
    hostname: spark-node-master-${ENV:?}
    environment:
      <<: *spark-env
      SPARK_MODE: master
      SPARK_UI_PORT: ${SPARK_UI_PORT:?}
      SPARK_EXECUTOR_MEMORY: ${SPARK_EXECUTOR_MEMORY:?}
      SPARK_MASTER_WEBUI_PORT: ${SPARK_MASTER_WEBUI_PORT:?}
    ports:
      - ${SPARK_UI_PORT:?}:${SPARK_UI_PORT:?}
      - ${SPARK_MASTER_WEBUI_PORT:?}:${SPARK_MASTER_WEBUI_PORT:?}

  spark-node-worker:
    <<: *node
    container_name: spark-node-worker-${ENV:?}
    hostname: spark-node-worker-${ENV:?}
    environment:
      <<: *spark-env
      SPARK_MODE: worker
      SPARK_WORKER_MEMORY: ${SPARK_WORKER_MEMORY:?}
      SPARK_WORKER_CORES: ${SPARK_WORKER_CORES:?}
      SPARK_WORKER_WEBUI_PORT: ${SPARK_WORKER_WEBUI_PORT:?}
    ports:
      - ${SPARK_WORKER_WEBUI_PORT:?}:${SPARK_WORKER_WEBUI_PORT:?}

# Using a dedicated subnet because the Docker default subnet conflicts
# with some of the CCAO's internal routing
networks:
  sparknet:
    ipam:
      config:
        - subnet: 211.55.0.0/16
    name: sparknet

secrets:
  AWS_CREDENTIALS:
    file: secrets/AWS_CREDENTIALS_FILE
  GH_PEM:
    file: secrets/GH_PEM
  IPTS_CONNECTION:
    file: secrets/IPTS_CONNECTION
  IPTS_PRD_PASSWORD:
    file: secrets/IPTS_PRD_PASSWORD
  IPTS_TST_PASSWORD:
    file: secrets/IPTS_TST_PASSWORD
  SPARK_ENV:
    file: secrets/SPARK_ENV
